<!DOCTYPE html>
<html lang="en" xmlns:th="thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>comment.html</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        #comment {
            width: 350px;
        }

        tbody tr:nth-child(odd) {
            background-color: #FFF2F2;
        }

        th {
            width: 80px;
            background-color: #FEEBFD;
        }

        th.w300 {
            width: 300px;
        }

        td {
            text-align: center;
        }
    </style>
    <script>
        $(document).ready(function () {
            list();
            $('#inputButton').on('click', sendComment);
            $('#commentTbody').on('click', '.delBtn', delComment); // 이벤트 위임 delBtn으로
            $('#commentTbody').on('click', '.upBtn', upComment);
        });

        function upComment() {
            console.log($(this).data('comment'));
            let updatedComment = prompt("수정하시겠습니까?", $(this).data('comment'));

            // 취소 누르면 종료
            if (updatedComment === null) return;

            // 내용 없이 확인 누르면 경고
            if (updatedComment.trim() === '') {
                alert("내용을 입력하세요.");
                return;
            }
            console.log(updatedComment)
            let num = $(this).data('num');

            $.ajax({
                url: `/board/comment/${num}`,
                type: 'patch', // 전체데이터를 바꿀 때는 put , 일부분을 바꿀때는 patch를 많이 씀.
                // data: { num: num, comment: updatedComment },
                data: JSON.stringify({ comment: updatedComment }),
                contentType: 'application/json',
                success: function () {
                    list();
                },
                error: function () {
                    alert("수정실패");
                }

            });
        }

        function delComment() {
            let result = confirm('삭제하시겠습니까');
            if (result) {
                let num = $(this).data('num');
                $.ajax({
                    url: `/board/comment/${num}`,
                    type: 'delete',
                    data: { num: num },
                    success: function () {
                        list();
                        // $(this).closest('tr').remove(); // 이거 써도 됨 성능 차이는 list()랑 크게 안나지만 그래도 이것도 알아두면 좋음 
                    },
                    error: function () {
                        alert("삭제실패");
                    }
                });
            }


        }

        // 댓글 달기(댓글 저장)
        function sendComment() {
            let name = $('#name').val().trim();
            let comment = $('#comment').val().trim();
            if (!name || !comment) {
                alert("이름과 댓글을 입력하세요.");
                return;
            }

            let ar = { name: name, comment: comment };

            $.ajax({
                url: '/board/comment/write',
                type: 'post',
                data: ar,
                success: function (str) {
                    $('#name').val('');
                    $('#comment').val('');
                    list();
                },
                error: function () {
                    alert('저장 실패');
                }
            });
        }

        // 데이터 가져오기
        function list() {
            $.ajax({
                url: '/board/comment/list',
                type: 'get',
                dataType: 'json',
                success: function (list) {
                    let str = "";
                    if (!list || list.length === 0) {
                        str = `
                            <tr>
                                <td colspan="5">작성한 글이 없습니다.</td>    
                            </tr>
                        `;
                    }
                    else {
                        $(list).each(function (idx, ob) {
                            str += `
                            <tr>
                                <td>${ob.num}</td>
                                <td>${ob.name}</td>
                                <td>${ob.comment}</td>
                                <td><button class="delBtn" data-num="${ob.num}" >삭제</button></td>
                                <td><button class="upBtn" data-comment="${ob.comment}" data-num="${ob.num}">수정</button></td>
                            </tr>
                        `;
                        });
                    }
                    $('#commentTbody').html(str);
                },
                error: function () {
                    alert("목록조회실패");
                }
            });
        }
    </script>
</head>

<body>
    <h1>[ 댓글 달기 ]</h1>

    <div>
        <input type="text" id="name" placeholder="작성자명을 입력하세요">
        <input type="text" id="comment" placeholder="댓글 내용을 입력하세요.">
        <button id="inputButton">저장</button>
    </div>
    <hr>
    <table>
        <thead>
            <tr>
                <th>번호</th>
                <th>작성자</th>
                <th class="w300">내용</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="commentTbody">
            <!-- 댓글 내용 출력 영역 -->
        </tbody>
    </table>


</body>

</html>